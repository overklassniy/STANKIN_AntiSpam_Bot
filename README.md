# Анти-спам система

Данный проект представляет собой комплексное решение для борьбы со спамом. Он включает в себя сбор и анализ данных, обучение различных моделей для обнаружения спама, интеграцию с Telegram через бота и разработку веб-панели для управления и мониторинга системы. Проект объединяет в себе возможности машинного обучения, автоматизации и веб-разработки, что позволяет эффективно выявлять спамовые сообщения и оперативно реагировать на них.

---

## Оглавление

- [Принципы работы системы](#принципы-работы-системы)
- [Установка и настройка](#установка-и-настройка)
  - [Клонирование репозитория и установка зависимостей](#клонирование-репозитория-и-установка-зависимостей)
  - [Настройка переменных окружения](#настройка-переменных-окружения)
  - [Настройка конфигурационного файла](#настройка-конфигурационного-файла)
  - [Подготовка моделей](#подготовка-моделей)
  - [Инициализация базы данных](#инициализация-базы-данных)
- [Используемые данные](#используемые-данные)
- [Скрипты и утилиты](#скрипты-и-утилиты)
- [Запуск компонентов проекта](#запуск-компонентов-проекта)
  - [Обучение и анализ моделей](#обучение-и-анализ-моделей)
  - [Telegram бот](#telegram-бот)
  - [Веб-панель управления](#веб-панель-управления)
  - [Основной скрипт](#основной-скрипт)
- [Структура проекта](#структура-проекта)
- [Поддержка](#поддержка)

---

## Принципы работы системы

### Машинное обучение
- **Анализ данных и предобработка:**  
  Исходные данные собираются из различных источников и хранятся в каталоге `data/`. Для их очистки и приведения к единому формату используется блокнот `ipynb/1. Подготовка данных.ipynb` и скрипты из `utils/preprocessing.py`.
  
- **Обучение моделей:**  
  Для классификации спама используются несколько моделей, включая RuBERT и модели на основе логистической регрессии, наивного байеса и случайного леса. Ноутбуки в каталоге `ipynb/` демонстрируют процесс обучения, дообучения и оценки эффективности моделей. Результаты сохраняются в каталоге `models/`.

### Telegram бот
- **Интеграция с мессенджером:**  
  Бот, реализованный в проекте, подключается к Telegram через API, используя токены, указанные в файле `.env`. Он осуществляет мониторинг входящих сообщений и отправляет уведомления администраторам. Запуск бота осуществляется командой `python run_bot.py`.

### Веб-панель управления
- **Административный интерфейс:**  
  Веб-панель предоставляет возможность отслеживания статистики работы системы, управления моделями и просмотра логов. Панель разработана с использованием современных веб-технологий и запускается через файл `run_panel.py`. Интерфейс построен с разделением на шаблоны (HTML), стили (CSS) и скрипты (JavaScript).

---

## Установка и настройка

### Клонирование репозитория и установка зависимостей

1. **Клонирование репозитория:**

   ```bash
   git clone https://github.com/overklassniy/STANKIN_AntiSpam_Bot.git
   cd STANKIN_AntiSpam_Bot
   ```

2. **Создание виртуального окружения и установка зависимостей:**

   ```bash
   python -m venv venv
   source venv/bin/activate  # для Linux/macOS
   venv\Scripts\activate     # для Windows

   pip install --upgrade pip
   pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
   pip install -r requirements.txt
   ```

### Настройка переменных окружения

Создайте файл `.env` в корне проекта и задайте необходимые переменные. Пример содержимого:

```ini
BOT_TOKEN=токен_бота_Telegram
TEST_BOT_TOKEN=токен_тестового_бота_Telegram
OPENAI_API_KEY=API_ключ_OpenAI
SECRET_KEY=секретный_ключ_базы_данных
ADMIN_PASSWORD=пароль_администратора
helpdesk_email=почта_техподдержки
```

### Настройка конфигурационного файла

Создайте файл `config.json` в корне проекта, используя следующий шаблон:

```json
{
    "TESTING": false,
    "BOT_NAME": "AntiSpam_bot",
    "CHAT_ID": -123456789,
    "LOGS_DIR": "logs",
    "MODELS_DIR": "models",
    "BERT_MODEL": "models/finetuned_rubert_tiny2",
    "BERT_THRESHOLD": 0.945,
    "ENABLE_CHATGPT": false,
    "MUTING": true,
    "PANEL_PORT": 2222,
    "PERMANENT_SESSION_LIFETIME": 60,
    "REMEMBER_COOKIE_DURATION": 10080,
    "PER_PAGE": 10
}
```

**Описание ключей:**

- `TESTING` – Режим тестирования. Если `true`, система использует тестовые параметры.
- `BOT_NAME` – @username Telegram бота, под которым его можно найти в Telegram.
- `CHAT_ID` – Идентификатор чата, в котором бот будет удалять спам-сообщения.
- `LOGS_DIR` – Директория для хранения логов работы системы.
- `MODELS_DIR` – Путь к каталогу с обученными моделями.
- `BERT_MODEL` – Путь к модели RuBERT, используемой для классификации сообщений.
- `BERT_THRESHOLD` – Порог уверенности для классификации сообщения как спам (значение от 0 до 1).
- `ENABLE_CHATGPT` – Флаг, включающий или отключающий использование ChatGPT для дополнительных оценок (true/false).
- `MUTING` – Флаг, включающий последовательное ограничение пользователя. Пользователь теряет право отправлять сообщения и медиафайлы на 24 часа / 7 дней / навсегда, в зависимости от рецидива нарушения.
- `PANEL_PORT` – Порт, на котором будет запущена веб-панель управления.
- `PERMANENT_SESSION_LIFETIME` – Время жизни пользовательской сессии (в минутах).
- `REMEMBER_COOKIE_DURATION` – Продолжительность действия опции "Запомнить меня" (в минутах).
- `PER_PAGE` – Количество записей, отображаемых на одной странице веб-панели.

### Подготовка моделей

Загрузите модели машинного обучения для распознавания сообщений из вкладки [`Releases`](https://github.com/overklassniy/STANKIN_AntiSpam_Bot/releases/latest) либо последовательно запустите `.ipynb` файлы в соответствующей папке.

### Инициализация базы данных

Перед запуском проекта необходимо выполнить инициализацию базы данных. Выполните следующие команды из корня проекта в активированном виртуальном окружении:

```bash
flask --app panel.app init_db
flask --app panel.app init_admin
flask --app panel.app init_spam
flask --app panel.app init_muted
```

Эти команды:
- **init_db** – создают и настраивают базу данных,
- **init_admin** – добавляют администратора для веб-панели,
- **init_spam** – инициализируют таблицы или записи, необходимые для работы анти-спам системы.

---

## Используемые данные

Все исходные данные расположены в директории `data/` и включают файлы различных форматов (JSON, CSV, TXT) с наборами данных для обучения и тестирования моделей. Некоторые файлы были получены из внешних источников (источники указаны в соответствующих Jupyter Notebook). Перед запуском обучения убедитесь, что данные корректно предобработаны, используя блокнот `ipynb/1. Подготовка данных.ipynb`.

---

## Скрипты и утилиты

В каталоге `utils/` находятся вспомогательные скрипты, которые облегчают работу с проектом:

- **apis.py** – Функции для работы с внешними API.
- **basic.py** – Основные утилиты и вспомогательные функции.
- **config_web.py** – Конфигурация для веб-сервиса.
- **predictions.py** – Функции для получения предсказаний от обученных моделей.
- **preprocessing.py** – Скрипты для предобработки и очистки данных.

---

## Запуск компонентов проекта

### Обучение и анализ моделей

Для подготовки данных, обучения моделей и оценки их эффективности используются Jupyter Notebook файлы, расположенные в каталоге `ipynb/`. Вы можете запустить их в [Jupyter Notebook](https://jupyter.org/) или [JupyterLab](https://jupyterlab.readthedocs.io/).

### Telegram бот

Запустите Telegram бота, используя следующую команду:

```bash
python run_bot.py
```

Бот использует токены, указанные в файле `.env`, для подключения к API Telegram и мониторинга входящих сообщений.

### Веб-панель управления

Для запуска веб-панели выполните команду:

```bash
python run_panel.py
```

Веб-панель предоставляет административный интерфейс для управления системой, просмотра статистики, логов и выполнения других операций.

### Основной скрипт

Файл `run.py` предназначен для интегрированного запуска нескольких компонентов системы или выполнения основных задач проекта.

---

## Структура проекта

После всех манипуляций структура проекта должна выглядеть так:

```
.
├── data/
│   ├── dataset.json
│   ├── dataset_discord.json
│   ├── dataset_telegram_kaggle.csv
│   ├── parsed_lols_2023.txt
│   ├── parsed_lols_2024.txt
│   ├── preprocessed.csv
│   ├── spam_samples_umputun.txt
│   └── test_clear.json
├── instance/
│   └── db.sqlite
├── ipynb/
│   ├── 1. Подготовка данных.ipynb
│   ├── 2. Обучение различных моделей.ipynb
│   ├── 3.1. Дообучение RuBert.ipynb
│   ├── 3.2. Дообучение RuBert с числовыми значениями.ipynb
│   └── 4. Дополнительные оценки.ipynb
├── models/
│   ├── finetuned_rubert_tiny2/
│   │   ├── config.json
│   │   ├── model.safetensors
│   │   ├── special_tokens_map.json
│   │   ├── tokenizer.json
│   │   ├── tokenizer_config.json
│   │   └── vocab.txt
│   ├── finetuned_rubert_tiny2_p/
│   │   ├── config.json
│   │   ├── model.safetensors
│   │   ├── special_tokens_map.json
│   │   ├── tokenizer.json
│   │   ├── tokenizer_config.json
│   │   └── vocab.txt
│   ├── finetuned_rubert_tiny2_with_numeric/
│   │   ├── config.json
│   │   ├── model.pth
│   │   ├── special_tokens_map.json
│   │   ├── tokenizer.json
│   │   ├── tokenizer_config.json
│   │   └── vocab.txt
│   ├── lr_model.pkl
│   ├── lr_sm_model.pkl
│   ├── nb_model.pkl
│   ├── nb_sm_model.pkl
│   ├── rf_model.pkl
│   ├── rf_sm_model.pkl
│   ├── scaler.pkl
│   └── vectorizer.pkl
├── panel/
│   ├── static/
│   │   ├── fonts/
│   │   │   ├── ALS_Sirius_Bold.otf
│   │   │   └── ALS_Sirius_Regular.otf
│   │   ├── images/
│   │   │   ├── stankin-logo.svg
│   │   │   └── stankin_max.svg
│   │   ├── scripts/
│   │   │   ├── hamburger.js
│   │   │   └── login_faq.js
│   │   └── styles/
│   │       ├── login.css
│   │       ├── main.css
│   │       ├── root.css
│   │       └── settings.css
│   ├── templates/
│   │   ├── login.html
│   │   ├── main.html
│   │   └── settings.html
│   ├── app.py
│   ├── auth.py
│   ├── db_models.py
│   └── main.py
├── utils/
│   ├── apis.py
│   ├── basic.py
│   ├── config_web.py
│   ├── predictions.py
│   └── preprocessing.py
├── .env
├── bot.py
├── config.json
├── requirements.txt
├── run_bot.py
├── run_panel.py
└── run.py
```

---

## Поддержка

Если у вас возникли вопросы, предложения или вы хотите внести улучшения, пожалуйста, создавайте [Issues](https://github.com/overklassniy/STANKIN_AntiSpam_Bot/issues) и [Pull Requests](https://github.com/overklassniy/STANKIN_AntiSpam_Bot/pulls). Ваш вклад очень важен для развития проекта!
